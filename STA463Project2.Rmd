---
title: "STA463Project2"
author: "Steve, Jairus, Allen"
date: "2023-04-27"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(ggplot2)
library(GGally)
library(ggfortify)
library(car)
```


## I. Introduction  

This project explores a data set pertaining to Airbnb prices in Amsterdam during weekdays. Each Airbnb listing is an observation, and is evaluated for room types, cleanliness, and distance from Amsterdam's city center.

Our variables under consideration:

* Y = price (Euros) 
* X1 = room_type (categorical: Private room, Entire home/apt)
* X2 = dist (distance from city center in kilometers)
* X3 = cleanliness_rating (numerical, ranging from 4 to 10)

We will first identify the structure of our data set:

```{r, echo=FALSE}
airbnb <- read.csv("airbnb.csv")
head(airbnb)
```

This project involves performing a confirmatory multiple regression analysis. Specifically, we seek to answer the following research question: Is there a relationship between Airbnb prices in Amsterdam and whether those Airbnbs are in private rooms versus Airbnbs in the entire home/apartment versus shared rooms?

=======

## II. Exploratory Data Analysis  
 
In the original Airbnb data set, the column X is merely an index column, and thus should be removed before performing any analyses. We will also remove any rows with N/A values if they are present. Since `room_type` is a categorical variable with 2 factors, we will encode it as a categorical factor variable, where Entire home/apt is 0, Private room is 1, and Shared room is 2.

```{r, echo=FALSE}
airbnb.mod <- airbnb[c("price", "cleanliness_rating", "room_type", "dist")]
#airbnb.mod <- na.omit(airbnb)
#airbnb$room_type <- as.factor (airbnb$room_type)
#airbnb$room_type <- as.numeric(airbnb$room_type)
airbnb.mod$private_room <-ifelse(airbnb$room_type == 'Private room', 1, 0)
airbnb.mod$shared_room <-ifelse(airbnb$room_type == 'Shared room', 1, 0)
airbnb.mod <- airbnb.mod[,-3]
head(airbnb.mod)
#airbnb.mod
```

We have removed all unnecessary columns and rows from our data set. Now we can create a scatter plot and correlation matrix of our variables: 


```{r, echo=FALSE}
#pairs(airbnb)
#create scatterplot matrix with ggplot
ggpairs(airbnb.mod)
cor(airbnb.mod)
```

It appears the graphs are heavily skewed. Price is skewed to the right; cleanliness rating is skewed to the left, and distance is skewed to the right. Since price, cleanliness rating, and distance are skewed, we will transform these variables later in our model and analysis. There seems to be a moderate negative correlation between private room and price of -0.434, an extremely weak positive correlation between cleanliness rating and price of 0.023, and a weak negative correlation between distance and price of -0.259. Also, there does not appear to be any multicollinearity between the predictors. For example, there is an extremely weak positive correlation coefficient of 0.032 between private room and cleanliness rating; an extremely weak negative correlation coefficient of -0.022 between distance and cleanliness rating; a weak negative correlation coefficient of -0.027 between shared room and cleanliness rating. There is a weak positive correlation between private room and distance of 0.102, and an extremely weak positive correlation between shared room and distance of 0.039, and an extremely weak negative correlation between private room and shared room of -0.075.

In context of our hypothesis question, there is a moderate negative correlation coefficient between private room and price, suggesting that the price is lower if the Airbnb is a private room than it would be if the Airbnb is the entire home/apartment. Similarly with a shared room, we have an extremely weak negative correlation between shared room and price, meaning if the Airbnb is a shared room, we expect the price to be lower than if the Airbnb was an entire home/apartment. Furthermore, there is a weak negative correlation between distance and price, meaning that the closer the Airbnb is to the center of the city (i.e. distance decreases), the price of the Airbnb increases. We will analyze these relationships further in our analysis section.

We will examine the distribution of Airbnb prices grouped by Airbnb room types through box plots.

```{r, echo=FALSE}
# Create box plots
ggplot(airbnb, aes(x=room_type, y=price,group=room_type)) + 
  geom_boxplot()
tapply(airbnb$price, airbnb$room_type, summary)
```

From the box plots, we can see that the range of prices for `Entire home/apt`, `Private room` and `Shared room` are very different. `Entire home/apt` ranges from a min of 128.90 Euros to a max of 7,78.90 Euros while the other two categories have much smaller ranges with `Private room` having a range from 143.7 to 1714.40 Euros and `Shared room` ranging from 192.90 to 479.2 Euros. The median prices are not as different with `Entire home/apt` being 625.30 Euros, `Private room` being 319.60 Euros and `Shared room` being 258.00 Euros. There are also many outliers in the `Entire home/apt` box plot, the box plot is skewed far right with the highest outlier being more than 4000 Euros from the second highest outlier. The `Private room` box plot also has multiple outliers but it is not as extremely skewed right as the `Entire home/apt` box plot and the `Shared room` boxplot only has one outlier meaning it shows very small signs of skewness.  

=======

## III Model and Analysis

The theoretical multiple regression model is as follows:

$Y_i = \beta_0 + \beta_1X_{1i} + \beta_2X_{2i} + \beta_3X_{3i} + \beta_4X_{4i}$

Where $Y_i$ is the Airbnb price in Euros, $X_{1i}$ is the cleanliness rating, $X_{2i}$ is the distance from city center in kilometers, $X_{3i}$ is the dummy variable for private room (1 if Airbnb is a private room, 0 otherwise), and $X_{4i}$ is the dummy variable for shared room (1 if Airbnb is a shared room, 0 otherwise). We have the default case of entire house, meaning that when $X_{3i}$ and $X_{4i}$ are 0, the Airbnb is the entire house.

$\beta_0$ is the intercept term (Airbnb price in Euros when the Airbnb has a cleanliness rating of 0, is 0 kilometers away from the city center, and the Airbnb is the entire house), $\beta_1$ is the slope for cleanliness rating, $\beta_2$ is the slope for distance from city center (kilometers), $\beta_3$ is the slope for whether the Airbnb is a private room, and $\beta_4$ is the slope for whether the Airbnb is a shared room.

This model also assumes that errors $\epsilon_i$ are normally distributed with a mean of $0$ and a variance of $\sigma^2$. We also assume that the error terms are independent, meaning $Cov(\epsilon_i, \epsilon_j) = 0$ for $i \neq j$.

Let's look at the fitted model:

```{r,echo=FALSE}
airbnb.lm1 <- lm(data=airbnb.mod, price ~ cleanliness_rating + dist + private_room + shared_room)
```

Now we check the assumptions of our model.

```{r,echo=FALSE}
summary(airbnb.lm1)
autoplot(airbnb.lm1)
```

We notice a fanning effect on Residuals vs. Fitted plot, indicating that there is non-constant variance. The normal Q-Q plot is clearly non-linear, indicating a violation in the normality assumption. We can also observe many points with high standardized residuals and high leverage on the Residuals vs Leverage plot. We propose applying a log-transformation on the response variable (price) and the numeric predictors (cleanliness_rating and dist) as a remedial measure. We will also identify the model with and without outliers and high leverage points.

We identify Leverage, DFFITS, Cook's Distance, DFBETAS plots, and the Variance Inflation Factor (VIF) scores to examine outlier points and possible multicollinearity.

```{r}
par(mfrow=c(2,2))
# leverage values
levs = hatvalues(airbnb.lm1)
#plot(levs, ylab="Leverages", xlab="Observation")

highleverage <- function(airbnb.lm1) {
p = length(coefficients(airbnb.lm1))
n = length(fitted(airbnb.lm.log))
ratio = p/n
plot(hatvalues(airbnb.lm1), main="Index Plot of Ratio")
abline(h=c(2,3)*ratio, col="red", lty=2)
identify(1:n, hatvalues(airbnb.lm1), names(hatvalues(airbnb.lm1)))
}
highleverage(airbnb.lm1)

# DFFITS
dffits.mr = dffits(airbnb.lm1)
plot(dffits.mr, ylab="DFFITS", xlab="Observation")

# Cook's distance
#cook.mr = cooks.distance(airbnb.lm1)
#plot(cook.mr, ylab="Cook's Distance", xlab="Observation")

cutoff <- 4/(nrow(airbnb$price)-length(airbnb.lm1$coefficients)-2)
plot(airbnb.lm1, which=4, cook.levels=cutoff)
abline(h=cutoff, lty=2, col="red")

# DFBETAS
dfbetas.mr = dfbetas(airbnb.lm1)
plot(dfbetas.mr[,2], ylab="DFBETAS x1")
```


```{r,echo=FALSE}
#vif(airbnb.lm1)
```

For our research hypothesis question, we test the following hypotheses:

* Null Hypothesis: $H_0: \beta_3 = \beta_4 = 0$
* Alternative Hypothesis: $H_a: \beta_3 \neq 0$ or $\beta_4 \neq 0$

```{r}
summary(airbnb.lm1)
```


By the summary above, we have that the p-value for the $\beta_3$ estimator is < 2e-16. We also have that the p-value for the $\beta_4$ estimator is 0.00914. These p-values are well below our significance level of 0.01, meaning there is sufficient evidence to reject the null hpyothesis. We can concluse $H_a: \beta_3 \neq 0$ or $\beta_4 \neq 0$, that is, whether or not the Airbnb is in the entire house, a private room, or a shared room is a statistically significant predictor for Airbnb price.



# DO NOT MODIFY BELOW THIS LINE (TO BE DONE AFTER ORIGINAL MODEL)
--------------------------------------------------------------------------------











##Appendix (TBD)

```{r,echo=FALSE}
airbnb.lm.log <- lm(log(price) ~ log(cleanliness_rating) + log(dist) + private_room + shared_room, data=airbnb.mod)
par(mfrow=c(2,2))
# leverage values
levs = hatvalues(airbnb.lm.log)
#plot(levs, ylab="Leverages", xlab="Observation")

highleverage <- function(airbnb.lm.log) {
p = length(coefficients(airbnb.lm.log))
n = length(fitted(airbnb.lm.log))
ratio = p/n
plot(hatvalues(airbnb.lm.log), main="Index Plot of Ratio")
abline(h=c(2,3)*ratio, col="red", lty=2)
identify(1:n, hatvalues(airbnb.lm.log), names(hatvalues(airbnb.lm1)))
}
highleverage(airbnb.lm.log)

# DFFITS
dffits.mr = dffits(airbnb.lm.log)
plot(dffits.mr, ylab="DFFITS", xlab="Observation")

# Cook's distance
#cook.mr = cooks.distance(airbnb.lm.log)
#plot(cook.mr, ylab="Cook's Distance", xlab="Observation")

cutoff <- 4/(nrow(airbnb$price)-length(airbnb.lm.log$coefficients)-2)
plot(airbnb.lm.log, which=4, cook.levels=cutoff)
abline(h=cutoff, lty=2, col="red")

# DFBETAS
dfbetas.mr = dfbetas(airbnb.lm.log)
plot(dfbetas.mr[,2], ylab="DFBETAS x1")

```

```{r,echo=FALSE}
vif(airbnb.lm.log)
```


We have low VIF scores very close to 1, indicating that we do not have any issues with multicollinearity. The threshold for high leverage points is found with the equation $3 * \frac{p}{n} = 3 * \frac{5}{1103} = 0.01359928$ We have a few high leverage points with leverages above 0.01359928. Observation 971 appears to be the point with very high Cook's distance, DFFITS, and DFBETAS x1. We should definitely exclude observation 971 if we want to analyze a fitted model without outliers.

Fitting a model with log transformations on response and numeric predictors:

```{r,echo=FALSE}
airbnb.mod$logrstandard <- rstandard(airbnb.lm.log)

airbnbNO <- airbnb.mod[-c(74,628,1103,971,100,134,191,8,726,1099,138,254,575,272,159,860,454,784),]

airbnbNO.lm.log <- lm(log(price) ~ log(cleanliness_rating) + log(dist) + private_room + shared_room, data=airbnbNO)
autoplot(airbnbNO.lm.log)
summary(airbnb.lm.log)
summary(airbnbNO.lm.log)
```



=======

Fitting a log-transformed model without outliers and high leverage points:

```{r,echo=FALSE}
# Have a conditional to exclude points with a standardized residual >= 3

```

Best subsets 

=======

## IV. Conclusion
